<% layout("layouts/boilerplate") %>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8 col-md-10 col-sm-12">
      <div class="card mb-5 mt-5">
        <div class="card-header">
          <h1 class="card-title text-center"><%= listing.title %></h1>
        </div>
        <div class="card-body"> 
          <div class="row">
            <div class="col-lg-7 col-md-12">
              <img src="<%= listing.image%> " alt="<%= listing.title %>" class="img-fluid rounded">
            </div>
            <div class="col-lg-5 col-md-12 mt-3">
              <h6 class="card-text">Seller: <%= listing.owner.username %> </h6>
              <p class="card-text"><%= listing.description %></p>
              <div class="card-text text-muted"><%= listing.location%></div>
              <div class="card-text mb-3" id="countdown"></div>
              
              <!-- Place bid for a listing -->
              <% if (!currentUser || !listing.owner.equals(currentUser._id)) {%>
              <form novalidate action="/listings/<%=listing._id%>/bids" class="needs-validation" method="post" id="place-bid" <% if (endTime) { %> <% if (new Date() >= new Date(endTime)) { %> style="display: none" <% } %> <% } %>>
                <div class="mb-3">
                  <label class="form-label" for="bidAmount">Bid Amount</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input class="form-control" type="text" name="bidAmount" id="bidAmount" required>
                  </div>
                </div>

                <div class="mb-3 form-check">
                  <input class="form-check-input" type="checkbox" name="agreement" id="agreement" required>
                  <label class="form-check-label" for="agreement">I agree to the terms and conditions</label>
                </div>

                <button class="btn btn-primary" id="placeBidBtn" onclick="showModal()">Place Bid</button>
              </form>
              

              <div class="modal fade" tabindex="-1" role="dialog" id="bidConfirmationModal" aria-labelledby="confirmModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 id="confirmModalLabel" class="modal-title">Confirm Bid</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                      <p>Are you sure you want to place this bid?</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                      <button type="button" class="btn btn-danger" id="confirmBidBtn">Yes</button>
                    </div>
                  </div>
                </div>
              </div>
              <%}%>
             
            </div>
            <div style='width: 100%; height: 25vh;' id='map' class="mb-3 mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



      <% if (endTime) { %>
        <% if (new Date() >= new Date(endTime)) { %>
          <div class="summary">
            <h1>Auction Summary</h1>
            <h6 class="card-text">Opened: <%= listing.startTime %> </h6>
            <h6 class="card-text">Closed: <%= listing.endTime %> </h6>
            <!-- Unique bidders -->
            <h6 class="card-text">bidders: <%= numBidders %> </h6> 
            <%if (listing.bids.length >= 1) {%>
              <!-- Total number of bids -->
              <h6 class="card-text">bids: <%= listing.bids.length %> </h6>
            <%}%>
            <% let highestBid = 0; %>
            <% for (let bid of listing.bids) { %>
              <% if (bid.bidAmount > highestBid) { %>
                <% highestBid = bid.bidAmount; %>
              <% } %>
            <% } %>
            <% if (highestBid > 0) { %>
              <h6 class="card-text">Winning bid: $<%= highestBid %> </h6>
            <% } %>
            <p class="card-text winner">Winner: 
              <% let winner = ''; %>
              <% for (let bid of listing.bids) { %>
                <% if (bid.bidAmount === highestBid) { %>
                  <% winner = bid.owner.username %>
                  <% break; %>
                <% } %>
              <% } %>
              <%= winner %>
            </p>
          </div>
        <% } %>
      <% } %>
          
      </div>
    </div>
  </div>
</div>


<% if (endTime) { %>
  <script>

// Get a reference to the "Place Bid" form
const placeBidForm = document.getElementById('place-bid');

// Get a reference to the "Place Bid" button
const placeBidBtn = document.getElementById('placeBidBtn');

// Get a reference to the "Confirm Bid" button
const confirmBidBtn = document.getElementById('confirmBidBtn');

// Get a reference to the checkbox
const agreementCheckbox = document.getElementById('agreement');

// Add an event listener to the "Place Bid" button
placeBidBtn.addEventListener('click', (event) => {
  event.preventDefault(); // Prevent the form from being submitted automatically
  if (agreementCheckbox.checked) {
    $('#bidConfirmationModal').modal('show'); // Show the confirmation modal
  } else {
    alert('Please accept the terms and conditions to place a bid.');
  }
});

// Add an event listener to the "Confirm Bid" button
confirmBidBtn.addEventListener('click', (event) => {
  event.preventDefault(); // Prevent the form from being submitted automatically
  placeBidForm.submit(); // Submit the form
  $('#bidConfirmationModal').modal('hide'); // Hide the confirmation modal
});

    const endTime = new Date("<%= endTime %>");
    const countdown = document.getElementById("countdown");

    function updateCountdown() {
      const now = new Date();
      const remainingTime = endTime - now;

      if (remainingTime <= 0) {
        countdown.innerHTML = "Auction has ended.";
        return;
      }

      const days = Math.floor(remainingTime / (1000 * 60 * 60 * 24));
      const hours = Math.floor((remainingTime % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);

      countdown.innerHTML = `Auction ends in: ${days}d ${hours}h ${minutes}m ${seconds}s`;
    }

    setInterval(updateCountdown, 1000);

    function validateCheckbox() {
      let checkbox = document.getElementById("agreement");
      if (checkbox.checked) {
        document.getElementById("place-bid").submit();
        return true;
      } else {
        alert("Please check the box before submitting");
        return false;
      }
    }

  </script>
<% } %>

<script>
  const mapToken = '<%-process.env.MAPBOX_TOKEN%>'
  const listing = <%- JSON.stringify(listing)%>
</script>
<script src="/scripts/Maps.js"></script>




 



 

 



 