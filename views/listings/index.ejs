<% layout("layouts/boilerplate") %>
<div class="container mt-5 mb-5">
  <form class="input-group input-group-md" action="/listings/search" method="GET">
    <input type="text" name="q" class="form-control" placeholder='Search listings by name or description, e.g. "Samsung"' required>
    <button type="submit" class="btn btn-primary">Search</button>
  </form> 
</div>
<div class="container">
  <div class="row">
    <% for (let listing of listings) { %>
      <% let endTime = new Date(listing.endTime); %>
      <div class="col-12 col-md-4 col-lg-3 mb-4">
        <div class="card product-card<%= endTime < new Date() ? 'auction-ended' : '' %>">
          <a href="/listings/<%=listing._id%>">
            <div class="image-container d-flex justify-content-center align-items-center">
              <img src="<%=listing.images[0].url%>" alt="A picture of <%= listing.title %>" class="thumbnail" >
            </div>
          </a>
          <div class="card-body">
            <h5 class="card-title text-truncate"><%= listing.title %></h5>
            <h6 class="card-text">Seller: <%= listing.owner.username %></h6>
            <% let highestBid = 0; %>
            <% if (listing.bids.length === 0) { %>
              <h6 class="card-text">No bids yet</h6>
            <% } else { %>
              <% for (let bid of listing.bids) { %>
                <% if (bid.bidAmount > highestBid) { %>
                  <% highestBid = bid.bidAmount; %>
                <% } %>
              <% } %>
              <% if (highestBid > 0) { %>
                <h6 class="card-text">Highest bid: $<%= highestBid %></h6>
              <% } %>
            <% } %>
            <h6 class="card-text text-muted"><%= listing.location %></h6>
            <form action="/watchlist/add" method="post">
              <input type="hidden" name="listingId" value="<%= listing._id %>">
              <button type="submit" class="btn btn-info w-100 <%= endTime < new Date() ? 'disabled' : '' %>">Add To Watchlist</button>
            </form>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>
